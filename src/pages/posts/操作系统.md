---
layout: ../../layouts/MarkdownPostLayout.astro
title: '操作系统原理笔记'
date: 2024-05-29
tags: ['操作系统']
---

## 一、操作系统引论

### 1.4.3 处理机工作的双重模式

- 为了确保OS正确运行，必须区分OS代码和用户代码的执行，以防止OS和用户程序收到错误用户程序的影响


![image-20240531182558852](https://abnerblog-1317606226.cos.ap-nanjing.myqcloud.com/202405311825894.png)

1. **特权指令**（可能引起损害的机器指令）
   - 是指在内核态下运行的指令
   - 不仅能访问用户空间，还能访问系统空间
   - 如启动外部设备、设置系统时钟、管中断、切换执行状态、I/O指令
2. **非特权指令**
   - 在用户态在运行的指令
   - 应用程序所使用的都是非特权指令
   - 防止应用程序的运行异常对系统造成破坏
   - 技能访问用户空间

### 1.5 操作系统的主要功能

![image-20240531180543900](https://abnerblog-1317606226.cos.ap-nanjing.myqcloud.com/202405311805020.png)

#### 1.处理机管理功能

- 处理机管理的主要功能有：创建和撤销进程，对各进程的运行进行协调，实现进程之间的信息交换，以及按照一定的算法把处理机分配给进程。

1. **进程控制**：为作业创建进程，撤销（终止）已结束的进程，以及控制进程在运行过程中的状态转换。
2. **进程同步**：对多个进程（含线程）的运行进行协调。
   1. 进程互斥方式：各进程在对临界资源进行访问时，采用互斥方式。
   2. 进程同步方式：在相互合作以完成共同任务的各进程间，由同步机构对它们执行次序加以协调。
3. **进程通信**：实现相互合作进程之间的信息交换。
4. **调度**：按一定算法进行处理器分配
   1. 作业调度：按照一定的算法，从后备队列中选出若干个作业，并为它们分配运行所需的资源；在将这些作业调入内存后，分别为它们建立进程，以使它们都成为可能会获得处理机的就绪进程，并将这些进程插入就绪队列。
   2. 进程调度：按照一定的算法，从进程的就绪队列中选出一个进程，将处理机分配给它，并为它设置运行现场，使其投入执行。

#### 2.存储器管理功能

- 存储器管理的主要任务是，为多道程序的运行提供良好的环境、提高存储器的利用率、方便用户使用，并能从逻辑上扩大内存。

1. **内存分配和回收**

   内存分配主要任务：

   - 为每道程序分配内存空间
   - 提高存储器利用率
   - 允许正在运行的程序申请附加的内存空间，以适应程序和数据动态增长的需要

   分配方式：

   1. 静态分配：每个作业的内存空间是在作业装入时确定的，在装入后的整个运行期间，不允许该作业再申请新的内存空间，也不允许该作业在内存中“移动”
   2. 动态分配：每个作业所要求的基本内存空间虽然也是在装入时确定，但允许作业在运行过程中继续申请新的附加内存空间，以适应程序和数据的动态增长，也允许作业在内存中“移动”

   - 内存回收任务是回收程序所占用的内存，并根据当前的内存管理算法将回收的内存经过处理放入对应的管理数据结构中，供下次分配时使用

2. **内存保护**

   主要任务：

   1. 确保每道用户程序都仅在自己的内存空间中运行，彼此互不干扰
   2. 绝不允许用户程序访问OS的程序和数据，也不允许其转移到非共享的其他用户程序中去执行

   一种比较简单的内存保护机制：

   - 设置两个界限寄存器，分别用于存放正在执行程序的上界和下界。在程序运行时，系统须对每条指令所要访问的地址进行检查，如果发生越界，则发出越界中断请求，以停止该程序的执行

3. **地址映射**

   - 将地址空间中的逻辑地址变换为内存空间中与之对应的物理地址

4. **内存扩充**

   - 借助虚拟存储技术，从逻辑上扩大内存容量

   1. 请求调入功能：系统允许在仅装入部分用户程序和数据的情况下，便能启动该程序运行：在程序运行过程总中，若发现继续运行所需的程序和数据尚未装入内存，则可向OS发出请求，由OS从磁盘中将所需部分调入内存
   2. 置换功能：若发现在内存中以无足够空间装入需要调入的程序和数据时，则系统应能将内存中的一部分暂时不用的程序和数据调至盘上，以腾出内存空间，然后再将所需调入的部分装入内存

#### 3.设备管理功能

- 完成用户进程提出的I/O请求，为用户进程分配所需的I/O设备，并完成指定的I/O操作
- 提高CPU和I/O设备的利用率，提高I/O速度，方便用户使用I/O设备

1. **缓冲管理**

   - 在I/O设备和CPU设备之间引入缓冲，缓和CPU和I/O设备速度不匹配的矛盾，提高CPU利用率，进而提高系统吞吐量

   1. 单缓冲机制
   2. 能实现双向同时传送数据的双缓冲机制
   3. 能供多个设备同时使用的公共缓冲机制

2. **设备分配**

   - 根据用户进程的I/O请求与系统现有资源情况，按照某种设备分配策略，为之分配其所需的设备

3. **设备处理**

   - 实现CPU和设备控制之间的通信

#### 4.文件管理功能

- 对用户文件和系统文件进行管理以方便用户使用，并保证文件的安全性

1. **文件存储空间管理**
   - 为每个文件分配必要的外存空间、提高外存的利用率，提高文件系统存取速度
2. **目录管理**
   - 为每个文件建立一个目录项，并对众多的目录项加以有效的组织，以实现方便的按名存取
3. **文件操作管理**
   - 负责完成文件的读写，文件保护

#### 5.接口管理功能

- 方便用户对OS的使用

1. **用户接口**

   - 便于用户直接或间接地控制自己的作业

   1. 联机用户接口(CLI)
   2. 脱机用户接口
   3. 图形用户接口(GUI)

2. **程序接口**

   - 便于用户程序在执行中访问系统资源

#### 6.现代操作系统的新功能

1. **保障系统安全**
   1. 认证技术
   2. 密码技术
   3. 访问控制技术
   4. 反病毒技术
2. **支持用户通过联网获取服务**
   1. 网络通信
   2. 资源管理
   3. 应用互操作
3. **可处理多媒体信息**
   1. 接纳控制功能
   2. 实时调度
   3. 存储多媒体文件

### 1.7 系统调用（了解）

![image-20240531182142671](C:\Users\86136\AppData\Roaming\Typora\typora-user-images\image-20240531182142671.png)

![image-20240531182249059](https://abnerblog-1317606226.cos.ap-nanjing.myqcloud.com/202405311822110.png)

![image-20240531182315923](https://abnerblog-1317606226.cos.ap-nanjing.myqcloud.com/202405311823963.png)

## 二、进程的描述与控制

### 2.2.2 进程的基本状态与转换

![image-20240531185423142](https://abnerblog-1317606226.cos.ap-nanjing.myqcloud.com/202405311854180.png)

- 进程的三种基本状态

  1. 就绪(Ready)状态
     - 当进程已分配到除CPU以外的所有必要的资源，只要获得处理机便可立即执行，这时的进程状态称为就绪状态
  2. 执行(Running)状态（运行态）
     - 当进程已获得处理机，其程序正在处理机上执行，此时的进程状态称为执行状态
  3. 阻塞(Block)状态（等待态）
     - 正在执行的进程，由于某个事件发生而无法执行时，便放弃处理机而处于阻塞状态。
     - 引起进程阻塞的事件有多种，如等待I/O完成、申请缓冲区不能满足、等待信号等

- 状态的转换

  - 一个进程在运行期间，不断地从一种状态转换到另一种状态，它可以多次处于就绪状态和执行状态，也可以多次处于阻塞状态

- 进程的五种基本状态（创建态、终止态）

  ![image-20240531191459033](https://abnerblog-1317606226.cos.ap-nanjing.myqcloud.com/202405311914088.png)

- 进程的五种基本状态（挂起和激活）

  ![image-20240531191655505](https://abnerblog-1317606226.cos.ap-nanjing.myqcloud.com/202405311916560.png)

- 进程的七种基本状态（创建、终止、挂起和激活）

  ![image-20240531191803895](https://abnerblog-1317606226.cos.ap-nanjing.myqcloud.com/202405311918941.png)

### 2.2.4 进程管理中的数据结构（pcb）

- 在OS的核心为每个进程专门定义了一个数据结构——进程控制块(PCB)。PCB作为进程实体的一部分，记录了操作系统所需的，用于描述进程的当前情况以及管理进程的全部信息，是操作系统中最重要的记录型数据结构。

PCB的作用

1. 作为独立运行基本单位的标志
2. 实现间断性运行方式
3. 提供进程管理所需要的信息
4. 提供进程调度所需要的信息
5. 实现与其他进程的同步与通信

### 2.3 进程控制（了解）

- 进程管理最基本的功能
- 一般由OS内核中的原语实现

1. 进程创建

   - 创建子进程可以继承父进程的所有资源，当子进程被撤销时，应将从父进程那里获得的资源归还给父进程
   - 撤销父进程时也必须同时撤销其所有的子进程

   引起进程创建的事件

   - 用户登录
   - 作业调度
   - 提供服务
   - 应用请求

2. 进程终止

   1. 正常结束
   2. 异常结束
   3. 外界干预

3. 进程阻塞与唤醒

4. 进程挂起与激活

### 2.4 进程通信（了解）

- 进程之间的信息交换
  - 低级进程通信：进程的同步和互斥
    - 效率低
    - 通信对用户不透明
  - 高级进程通信
    - 使用方便
    - 高效地传送大量数据

### 2.5 线程的概念

- 减少程序在并发执行时所付出的时空开销，使OS具有更好的并发性
- 进程的基本属性
  - 可拥有资源的独立单位
  - 同时是一个可独立调度和分派的基本单位
- 程序并发执行所需付出的时空开销
  - 创建进程：系统在创建一个进程时，必须为它分配其所必需的、除处理机以外的所有资源，如内存空间、I/O设备，以及建立相应的PCB
  - 撤销进程：系统在撤消进程时，又必须先对其所占有的资源执行回收操作，然后再撤消PCB
  - 进程切换：对进程进行上下文切换时，需要保留当前进程的CPU环境，设置新选中进程的CPU环境，因而须花费不少的处理机时间
- 进程是拥有资源的基本单位（传统进程称为重型进程）
- 线程作为调度和分派的基本单位（又称为轻型进程）
- 线程和进程的比较
  1. 调度的基本单位
     - 在传统的OS中，拥有资源、独立调度和分派的基本单位都是进程
     - 在引入线程的OS中，线程作为调度和分派的基本单位，进程作为资源拥有的基本单位
     - 在同一进程中，线程的切换不会引起进程切换，在由一个进程中的线程切换到另一个进程中的线程时，将会引起进程切换
  2. 并发性
     - 在引入线程的操作系统中，不仅进程之间可以并发执行，而且在一个进程中的多个线程之间，也可并发执行
  3. 拥有资源
     - 进程是系统中拥有资源的一个基本单位，它可以拥有资源
     - 线程本身不拥有系统资源，仅有一点保证独立运行的资源
     - 允许多个线程共享其隶属进程所拥有的资源
  4. 独立性
     - 同一进程中的不同线程之间的独立性要比不同进程之间的独立性低得多
  5. 系统开销
     - 在创建或撤销进程时，OS所付出的开销将显著大于创建或撤销线程时的开销
     - 线程切换的代价远低于进程切换的代价
     - 同一线程中的多个线程之间的同步和通信也比进程的简单
  6. 支持多处理机系统
     - 在单线程进程中，不管有多少处理机，进程只能运行在一个处理机上
     - 对于多线程进程，可以将一个进程的多个线程分配到不同的处理机上并行运行
  7. 线程的状态
     1. 执行状态：表示线程已获得处理机而正在运行
     2. 就绪状态：指线程已具备了各种执行条件，只须再获得CPU便可执行
     3. 阻塞状态，指线程在执行中因某事件受阻而处于暂停状态，例如，当一个线程执行从键盘读入数据的系统调用时，该线程就被阻塞

## 三、处理机调度与死锁

### 作业调度

- 调度层次
  1. 高级调度：又称作业调度，调度对象是作业，主要用于多道批处理系统中，而在分时和实时系统中不设置
  2. 低级调度：又称进程调度或短程调度，调度对象是进程，最基本的调度
  3. 中级调度：又称内存调度，目的是提高内存利用率和系统吞吐量，将那些暂时不能运行的进程调至外存等待，此时进程的状态称为挂起
     - 其中进程调度的运行频率最高
     - 作业调度周期最长
     - 中间调度的运行频率介于两者之间

- 进程调度任务
  - 保存处理机的现场信息
  - 按某种算法选取进程
  - 把处理器分配给进程
- 进程调度机制
  - 排队器：用于将就绪进程插入相应的就绪队列
  - 分派器：用于将选定的进程移出就绪队列
  - 上下文切换器：进行新旧进程之间的上下文切换

- 调度方式

  - 非抢占式：一旦把处理机分配给某进程后，便让该进程一直执行，直至该进程完成或发生某件事而被阻塞时，才再把处理机分配给其他进程，绝不允许某进程抢占已经分配出去的处理机
  - 抢占方式：允许调度进程根据某种原则，去暂停某个正在执行的进程，将已分配给该进程的处理机重新分配给另一进程（现代OS广泛采用）
    - 优先权原则：允许优先权高的新到进程抢占当前进程的处理机
    - 短作业优先原则：短作业可以抢占当前较长作业的处理机
    - 时间片原则：各进程按时间片运行，当一个时间片用完后，便停止该进程的执行而重新进行调度

- 处理机调度目的

  - 资源利用率
  - 公平性
  - 平衡性
  - 策略强制执行

- 评价指标

  - CPU利用率

    ![image-20240531225648746](https://abnerblog-1317606226.cos.ap-nanjing.myqcloud.com/202405312256789.png)

  - 系统吞吐量：单位时间内完成作业的数量

    系统吞吐量=总共完成作业数量/花费时间

  - 周转时间：从作业被提交开始到作业完成为止的时间间隔

    周转时间=该作业完成时间 - 该作业提交时间

  - 平均周转时间：所有作业周转时间的均值

    平均周转时间=各作业周转时间之和/作业道数

  - 带权周转时间=作业周转时间/作业实际运行时间=（该作业完成时间-该作业提交时间）/作业实际运行时间

  - 平均带权周转时间=各作业带权周转时间之和/作业数

  带权周转时间与周转时间都是越小越好。

  带权周转时间必然>=1

  - 等待时间：进程/作业处于等待处理机状态时间之和
  - 响应时间：从用户提交请求到首次产生相应的时间

### FCFS先来先服务

- 有利于长作业而不利于短作业
- 有利于CPU繁忙型作业而不利于I/O繁忙型作业
- 公平、容易实现，不会导致饥饿

### SJF短作业优先（SPF短进程优先）

- 追求最少的平均等待时间、平均周转时间、平均带权周转时间
- 必须预知作业的运行时间（有可能造假）
- 不能保证紧迫性作业会被及时处理
- 对长作业不利，容易导致饥饿

### HRRN高响应比优先

- 响应比=（等待时间+要求服务时间）/要求服务时间=响应时间/要求服务时间
- 算法实质是动态优先权（利用老化解决饥饿）
- 等待时间相同时，退化成SJF
- 要求服务时间相同时，退化成FCFS
- 每次调度前，需要计算优先权，增加系统开销

### RR轮转调度算法

- 转为分时系统设计，类似于FCFS，但增加了抢占

### 死锁

- 指多个进程再运行过程中因资源问题而造成的一种僵局，当进程处于这种僵持状态时，若无外力作用，这些进程都将永远不能再向前推进

- 产生原因
  1. 竞争不可抢占性资源引起死锁
  2. 竞争可消耗资源引起死锁
  3. 进程推进顺序不当引起死锁
- 死锁产生的必要条件
  1. 产生互斥
  2. 请求和保持条件
  3. 不剥夺条件
  4. 循环等待条件

- 处理死锁方法
  1. 采用某个协议，确保系统永远不会进入死锁状态
     - 静态策略：死锁预防
     - 动态策略：死锁避免
  2. 允许系统进入死锁状态，检测然后恢复系统
     - 动态策略：死锁检测与死锁恢复
  3. 忽略问题，假装系统中从未出现过死锁（被大部分系统采用，如UNIX）
     - 鸵鸟算法

- 预防死锁
  - 破坏“请求和保持”条件
  - 破坏“不剥夺”条件
  - 破坏“循环等待”条件

## 四、进程同步

### 临界资源

- 系统中某些资源一次只允许一个进程使用，称这样的资源为临界资源或互斥资源或共享变量
- 诸进程间应采取互斥方式，实现对这种资源的共享
- 许多硬件资源如打印机、磁带机等，都属于临界资源

### 临界区

- 不论是硬件资源还是软件临界资源，多个进程必须互斥地对它进行访问。人们把在每个进程中临界访问资源地那段代码称为临界区
